<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black" />
        <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1.0, maximum-scale=1.0, minimal-ui" />
        
        <title>File Manager</title>
        
        <script src="/js/greyspots.js" type="text/javascript"></script>
        <link href="/css/greyspots.css" type="text/css" rel="stylesheet" />
        
        <script>
            var arrCurrentPath = [],
                arrHistory = [],
                
                arrCheckedPaths = [],
                arrCheckedPathTypes = [],
                
                arrOldDevPath = [],
                arrOldWebrootPath = [],
                arrOldRolePath = [],
                
                bolShowingDeleted = false,
                
                strFolder = 'role',
                strActionLink = '/v1/env';

            // order checked files and folders in the correct manner (to prevent errors)
            //      Example: lets say that we must remove 2 folders and one file (in that order)
            //          rm all/
            //          rm all/bar/       <== ERROR! folder "all" does not exist
            //          rm all/test.txt   <== ERROR! folder "all" does not exist
            //          
            //      Solution: order files first then folder paths with the most slashes first
            //          rm all/test.txt
            //          rm all/bar/
            //          rm all/
            //
            // this function takes a list of files/folders and sorts it in the aforementioned order
            //      then returns the combined array of the files and folders
            function sortPathArraysInOperationOrder(arrFiles, arrFolders) {
                'use strict';

                // sort folders by number of slashes (greatest number of slashes to least number of slashes)
                arrFolders.sort(function(a, b) {
                    return (b.match(/\//g) || '').length - (a.match(/\//g) || '').length;
                });

                return arrFiles.concat(arrFolders);
            }
            
            // prefix a file name with the current directory path
            function filePathPrefix(strFileName) {
                'use strict';
                return (arrCurrentPath.length > 0 ? arrCurrentPath.join('/') + '/' : '') + strFileName;
            }
            
            // sort checked array
            function getCheckedInOrder() {
                'use strict';
                var i, len, arrFiles = [], arrFolders = [];

                // seperate files and folders
                for (i = 0, len = arrCheckedPaths.length; i < len; i += 1) {
                    if (arrCheckedPathTypes[i] === 'file') {
                        arrFiles.push(arrCheckedPaths[i]);
                    } else {
                        arrFolders.push(arrCheckedPaths[i]);
                    }
                }

                return sortPathArraysInOperationOrder(arrFiles, arrFolders);
            }
            
            
             // get/refresh the list of files and folders for the current path
            function listCurrentDirectory(bolAddToHistory) {
                'use strict';
                if (bolAddToHistory !== false) {
                    arrHistory.push(arrCurrentPath.slice(0));
                }
                
                if (arrHistory.length === 1) {
                    document.getElementById('button-back').setAttribute('disabled', '');
                } else {
                    document.getElementById('button-back').removeAttribute('disabled');
                }
                
                if (arrCurrentPath.length === 0) {
                    document.getElementById('button-up').setAttribute('disabled', '');
                } else {
                    document.getElementById('button-up').removeAttribute('disabled');
                }

                if (arrCheckedPaths.length === 0) {
                    document.getElementById('button-move').setAttribute('disabled', '');
                    document.getElementById('button-rename').setAttribute('disabled', '');
                    document.getElementById('button-copy').setAttribute('disabled', '');
                    document.getElementById('button-delete').setAttribute('disabled', '');
                    document.getElementById('button-checked').setAttribute('disabled', '');
                    document.getElementById('current-action-container').innerHTML = '';
                } else {
                    document.getElementById('button-move').removeAttribute('disabled');
                    document.getElementById('button-rename').removeAttribute('disabled');
                    document.getElementById('button-copy').removeAttribute('disabled');
                    document.getElementById('button-delete').removeAttribute('disabled');
                    document.getElementById('button-checked').removeAttribute('disabled');
                }

                document.getElementById('current-path').textContent = filePathPrefix('') || 'File Manager';

                // list files/folders
                GS.addLoader('file-list-load', 'Loading...');
                GS.ajaxJSON(strActionLink + '/action_file', 'action=list' + // (bolShowingDeleted ? 'list_deleted' : 'list') + // list or list_deleted
                                                           '&folder=' + strFolder + '&path=' + encodeURIComponent(arrCurrentPath.join('/')), function(response, error) {
                    var i, len, strHTML = '', data, strCurrentPath, strAnchorPath;
                    
                    GS.removeLoader('file-list-load');
                    
                    if (!error) {
                        data = response.dat;
                        
                        data.directories = data.directories || [];
                        data.files = data.files || [];
                        
                        data.directories.sort();
                        data.files.sort();

                        strHTML += '<h3>Folders:</h3>';
                        for (i = 0, len = data.directories.length; i < len; i += 1) {
                            strCurrentPath = filePathPrefix(data.directories[i]);
                            
                            strHTML += '<div flex-horizontal link="' + strCurrentPath + '">' +
                                            '<gs-checkbox class="check" remove-right type="folder" ' + (arrCheckedPaths.indexOf(strCurrentPath) >= 0 ? 'value="true"' : '') + '></gs-checkbox>' +
                                            '<gs-button class="folder" remove-left flex>' + encodeHTML(data.directories[i]) + '</a>' +
                                        '</div> ';
                        }

                        strHTML += '<br />';
                        strHTML += '<h3>Files:</h3>';

                        for (i = 0, len = data.files.length; i < len; i += 1) {
                            strCurrentPath = filePathPrefix(data.files[i]);
                            strAnchorPath = strCurrentPath;
                            
                            if (strFolder === 'dev') {
                                if (strAnchorPath.indexOf('developer_g') === 0) {
                                    strAnchorPath = '/v1/dev/' + strAnchorPath
                                } else {
                                    strAnchorPath = '/v1/app/' + strAnchorPath
                                }
                                
                            } else if (strFolder === 'role') {
                                strAnchorPath = '/v1/role/' + strAnchorPath;
                                
                            } else {
                                strAnchorPath = '/' + strAnchorPath;
                            }
                            
                            strHTML += '<div flex-horizontal link="' + strCurrentPath + '">' +
                                        '<gs-checkbox class="check" type="file" ' + (arrCheckedPaths.indexOf(strCurrentPath) >= 0 ? 'value="true"' : '') + ' remove-right></gs-checkbox>' +
                                        '<gs-button "target="_blank" href="/v1/app/all/file_manager/file_edit.html?link=' + encodeURIComponent(strCurrentPath) +
                                                            '&folder=' + strFolder + '" icononly icon="file-text-o" title="Open file editor for this file..." remove-all></gs-button>';
                            
                            strHTML += '<gs-button flex href="' + encodeHTML(strAnchorPath) + '" target="_blank" class="file" remove-left>' + encodeHTML(data.files[i]) + '</gs-button>' +
                                    '</div>';
                        }
                        
                        document.getElementById('file-list').innerHTML = strHTML;
                    } else {
                        GS.ajaxErrorDialog(data, function() {
                            listCurrentDirectory(false);
                        }, function () {
                            arrCurrentPath.pop();
                            listCurrentDirectory(false);
                        });
                    }
                });
                
                if (bolShowingDeleted) { // === true was not neccesary
                    GS.addLoader('dead-file-list-load', 'Loading Dead Files...');
                    GS.ajaxJSON(strActionLink + '/action_file', 'action=list_deleted' +
                                                                '&folder=' + strFolder + '&path=' + encodeURIComponent(arrCurrentPath.join('/')), function (response, error) {
                        var i, len, strHTML = '', data, strCurrentPath, strAnchorPath;
                        
                        GS.removeLoader('dead-file-list-load');
                        
                        if (!error) {
                            data = response.dat;
                            
                            data.files.sort();
                            
                            strHTML += '<h3>Deleted Files:</h3>';
                            
                            for (i = 0, len = data.files.length; i < len; i += 1) {
                                strCurrentPath = filePathPrefix(data.files[i]);
                                strAnchorPath = strCurrentPath;
                                
                                if (strFolder === 'dev') {
                                    if (strAnchorPath.indexOf('developer_g') === 0) {
                                        strAnchorPath = '/v1/dev/' + strAnchorPath
                                    } else {
                                        strAnchorPath = '/v1/app/' + strAnchorPath
                                    }
                                    
                                } else if (strFolder === 'role') {
                                    strAnchorPath = '/v1/role/' + strAnchorPath;
                                    
                                } else {
                                    strAnchorPath = '/' + strAnchorPath;
                                }
                                
                                strHTML += '<gs-button "target="_blank" href="/v1/dev/developer_g/file_manager/file_edit.html?link=' + encodeURIComponent(strCurrentPath) +
                                                                '&folder=' + strFolder + '" iconleft icon="file-text-o" title="Open file editor for this file...">' +
                                                encodeHTML(data.files[i]) +
                                            '</gs-button>';
                            }
                            
                            document.getElementById('deleted-file-list').innerHTML = strHTML;
                            
                        } else {
                            GS.ajaxErrorDialog(data, function() {
                                listCurrentDirectory(false);
                            }, function () {
                                arrCurrentPath.pop();
                                listCurrentDirectory(false);
                            });
                        }
                    });
                } else {
                    document.getElementById('deleted-file-list').innerHTML = '';
                }
            }
            
            function insertFile(strFileName) {
                'use strict';
                GS.addLoader('file-insert', 'Creating File...');
                
                // OLD: action=write&path=
                // NEW: action=create_file&path=
                
                GS.ajaxJSON(strActionLink + '/action_file', 'action=create_file&folder=' + strFolder + '&path=' + encodeURIComponent(strFileName) + '&content=', function(data, error) {
                    GS.removeLoader('file-insert');
                    
                    if (!error) {
                        arrCheckedPaths = [];
                        arrCheckedPathTypes = [];
                        listCurrentDirectory(false);
                        
                    } else {
                        GS.ajaxErrorDialog(data, function() {
                            insertFile(strFileName);
                        });
                    }
                });
            }
            
            function insertFolder(strFolderName) {
                'use strict';
                GS.addLoader('folder-insert', 'Creating Folder...');
                GS.ajaxJSON(strActionLink + '/action_file', 'action=create_folder&folder=' + strFolder + '&path=' + encodeURIComponent(strFolderName), function(data, error) {
                    GS.removeLoader('folder-insert');
                    
                    if (!error) {
                        arrCheckedPaths = [];
                        arrCheckedPathTypes = [];
                        listCurrentDirectory(false);
                        
                    } else {
                        GS.ajaxErrorDialog(data, function() {
                            insertFolder(strFolderName);
                        });
                    }
                });
            }
            
            function movePaths(pathsFrom, pathsTo) {
                'use strict';
                GS.addLoader('file-and-folder-move', 'Moving Paths...');
                GS.ajaxJSON(strActionLink + '/action_file', 'action=mv_file&folder=' + strFolder +
                                                            '&paths_from=' + encodeURIComponent(pathsFrom) +
                                                            '&paths_to=' + encodeURIComponent(pathsTo), function(data, error) {
                    GS.removeLoader('file-and-folder-move');
                    
                    if (!error) {
                        arrCheckedPaths = [];
                        arrCheckedPathTypes = [];
                        listCurrentDirectory(false);
                        
                    } else {
                        GS.ajaxErrorDialog(data, function() {
                            movePaths(pathsFrom, pathsTo);
                        });
                    }
                });
            }
            
            function copyPaths(pathsFrom, pathsTo) {
                'use strict';
                GS.addLoader('file-and-folder-copy', 'Moving Paths...');
                GS.ajaxJSON(strActionLink + '/action_file', 'action=cp_file&folder=' + strFolder +
                                                                     '&paths_from=' + encodeURIComponent(pathsFrom) +
                                                                     '&paths_to=' + encodeURIComponent(pathsTo), function(data, error) {
                    GS.removeLoader('file-and-folder-copy');
                    
                    if (!error) {
                        arrCheckedPaths = [];
                        arrCheckedPathTypes = [];
                        listCurrentDirectory(false);
                        
                    } else {
                        GS.ajaxErrorDialog(data, function() {
                            copyPaths(pathsFrom, pathsTo);
                        });
                    }
                });
            }
            
            function renamePaths(pathsFrom, pathsTo) {
                'use strict';
                GS.addLoader('file-and-folder-rename', 'Rename Paths...');

                // need to make sure that the files/folders are renamed in order
                GS.ajaxJSON(strActionLink + '/action_file', 'action=mv_file&folder=' + strFolder +
                                                                    '&paths_from=' + encodeURIComponent(pathsFrom) +
                                                                    '&paths_to=' + encodeURIComponent(pathsTo), function(data, error) {
                    GS.removeLoader('file-and-folder-rename');
                    
                    if (!error) {
                        arrCheckedPaths = [];
                        arrCheckedPathTypes = [];
                        listCurrentDirectory(false);
                        
                    } else {
                        GS.ajaxErrorDialog(data, function() {
                            renamePaths(pathsFrom, pathsTo);
                        });
                    }
                });
            }
            
            function deletePaths(paths) {
                'use strict';
                GS.addLoader('file-and-folder-delete', 'Delete Paths...');
                GS.ajaxJSON(strActionLink + '/action_file', 'action=rm&folder=' + strFolder + '&paths=' + encodeURIComponent(paths), function(data, error) {
                        GS.removeLoader('file-and-folder-delete');
                        
                        if (!error) {
                            arrHistory = [];
                            arrCheckedPaths = [];
                            arrCheckedPathTypes = [];
                            listCurrentDirectory();
                            
                        } else {
                            GS.ajaxErrorDialog(data, function() {
                                deletePaths(paths);
                            });
                        }
                });
            }
            
            window.addEventListener('load', function (event) {
                var loadFunction, operateFunction;
                
                listCurrentDirectory();
                
                // when you click on a folder button add the folder name to the array of folder
                //      names that make up the current path then refresh the list of files/folders
                document.getElementById('file-list').addEventListener('click', function (event) {
                    if (event.target.classList.contains('folder')) {
                        arrCurrentPath.push(event.target.textContent);
                        listCurrentDirectory();
                    }
                });
                
                // one of the left side checkboxes are checked add the file or folder to the array of checked paths
                //      else if the checkbox is unchecked than remove the path from the list 
                document.getElementById('file-list').addEventListener('change', function (event) {
                    var path = event.target.parentNode.getAttribute('link');
                    
                    //console.log(event.target);
                    
                    if (event.target.value === 'true') {
                        arrCheckedPaths.push(path);
                        arrCheckedPathTypes.push(event.target.getAttribute('type'));
                    } else {
                        arrCheckedPathTypes.splice(arrCheckedPaths.indexOf(path), 1);
                        arrCheckedPaths.splice(arrCheckedPaths.indexOf(path), 1);
                    }

                    if (arrCheckedPaths.length > 0) {
                        document.getElementById('button-move').removeAttribute('disabled');
                        document.getElementById('button-rename').removeAttribute('disabled');
                        document.getElementById('button-copy').removeAttribute('disabled');
                        document.getElementById('button-delete').removeAttribute('disabled');
                        document.getElementById('button-checked').removeAttribute('disabled');
                    } else {
                        document.getElementById('button-move').setAttribute('disabled', '');
                        document.getElementById('button-rename').setAttribute('disabled', '');
                        document.getElementById('button-copy').setAttribute('disabled', '');
                        document.getElementById('button-delete').setAttribute('disabled', '');
                        document.getElementById('button-checked').setAttribute('disabled', '');
                        document.getElementById('current-action-container').innerHTML = '';
                    }
                });
                
                // refresh button in header
                document.getElementById('button-refresh').addEventListener('click', function (event) {
                    listCurrentDirectory(false);
                });
                
                // override CMD/CTRL - R
                window.addEventListener('keydown', function (event) {
                    var intKeyCode = event.which || event.keyCode;
                    
                    if ((event.ctrlKey || event.metaKey) && intKeyCode === 82) {
                        event.preventDefault();
                        event.stopPropagation();
                        listCurrentDirectory(false);
                    }
                });
                
                
                document.getElementById('button-checked').addEventListener('click', function(event) {
                    var i, len, strHTML;
                    
                    for (i = 0, len = arrCheckedPaths.length, strHTML = ''; i < len; i += 1) {
                        strHTML += '<div flex-horizontal>' +
                                        '<gs-checkbox id="checked-list-checkbox-' + i + '" value="true" ' +
                                                    'path="' + encodeHTML(arrCheckedPaths[i]) + '" ' +
                                                    'type="' + encodeHTML(arrCheckedPathTypes[i]) + '"></gs-checkbox>' +
                                        '<label for="checked-list-checkbox-' + i + '" flex>' + encodeHTML(arrCheckedPaths[i]) + '</label>' +
                                    '</div>';
                    }
                    
                    GS.dialog({
                        'header': 'List of files/folders that are checked off',
                        'content': '<div id="checked-off-list" style="padding: 1em;">' + strHTML + '</div>',
                        'after_open': function() {
                            document.getElementById('checked-off-list').addEventListener('change', function (event) {
                                var path = event.target.getAttribute('path');
                                
                                if (event.target.value === 'true') {
                                    arrCheckedPaths.push(path);
                                    arrCheckedPathTypes.push(event.target.getAttribute('type'));
                                } else {
                                    arrCheckedPathTypes.splice(arrCheckedPaths.indexOf(path), 1);
                                    arrCheckedPaths.splice(arrCheckedPaths.indexOf(path), 1);
                                }
                            });
                        },
                        'after_close': function() {
                            listCurrentDirectory(false);
                        }
                    });
                });
                
                document.getElementById('button-back').addEventListener('click', function(event) {
                    arrHistory.pop(); // remove current folder from history
                    arrCurrentPath = arrHistory.pop().slice(0);
                    
                    listCurrentDirectory();
                });
                
                document.getElementById('button-up').addEventListener('click', function(event) {
                    arrCurrentPath.pop();
                    
                    listCurrentDirectory();
                });
                
                // when the form is submitted this iframe is reloaded
                //      when it is reloaded we parse the data that is now in it looking for success
                //loadFunction = 
                document.getElementById('upload-response-iframe').addEventListener('load', function (event) {
                    var strResponseText = document.getElementById('upload-response-iframe').contentWindow.document.body.textContent,
                        jsnResponse, strResponse, bolError, strError;
                    
                    //console.log('1***', strResponseText);
                    
                    // get error text
                    try {
                        jsnResponse = JSON.parse(strResponseText);
                        
                    } catch (err) {
                        strResponse = strResponseText;
                    }
                    
                    if (jsnResponse) {
                        if (jsnResponse.stat === true) {
                            bolError = false;
                        } else {
                            bolError = true;
                            if (jsnResponse.dat && jsnResponse.dat.error) {
                                strError = jsnResponse.dat.error;
                            } else {
                                strError = jsnResponse.dat;
                            }
                        }
                    } else {
                        bolError = true;
                        strError = strResponse;
                    }
                    
                    // if no error destroy new file popup
                    if (!bolError) {
                        GS.dialogClose(document.getElementsByTagName('gs-dialog')[0], 'cancel');
                        
                    // if error open error popup
                    } else {
                        GS.msgbox('Error', strError, 'okonly');
                    }
                    
                    listCurrentDirectory(false);
                    GS.removeLoader('file-upload');
                });
                
                document.getElementById('button-upload-file').addEventListener('click', function(event) {
                    GS.dialog({
                        'header': 'Create a new File',
                        'content': '<div style="padding: 1em;">' +
                                    '   <form id="form-file-upload" action="' + strActionLink + '/action_upload" method="POST" enctype="multipart/form-data" target="upload_response">' +
                                    '       <label for="upload-file-content">File:</label>' +
                                    '       <gs-text type="file" id="upload-file-content" name="file_content"></gs-text>' +
                                    '       <br />' +
                                    '       <label for="upload-file-name">File Path:</label>' +
                                    '       <gs-text id="upload-file-name" name="file_name" value="' + (strFolder !== 'role' ? strFolder + '/' : '') + filePathPrefix('') + '" /></gs-text>' +
                                    '   </form>' +
                                    '   <br />' +
                                    '   <gs-button id="new-file-upload">Upload File</gs-button>' +
                                    '</div>',
                        'buttons': ['Cancel'],
                        'after_open': function() {
                            var loadFunction;
                            
                            // upload existing file
                            document.getElementById('new-file-upload').addEventListener('click', function(event) {
                                var strFile = document.getElementById('upload-file-content').value,
                                    strName = document.getElementById('upload-file-name').value;
                                
                                if (strName === '' && strFile === '') { // no values (no file and no file path)
                                    GS.msgbox('Error', 'No values in form. Please fill in the form.', 'okonly');

                                } else if (strFile === '') { // one value missing (no file)
                                    GS.msgbox('Error', 'No file selected. Please select a file using the file input.', 'okonly');

                                } else if (strName === '') { // one value missing (no file path)
                                    GS.msgbox('Error', 'No value in file path textbox. Please fill in file path textbox.', 'okonly');

                                } else { // values are filled in submit the form
                                    document.getElementById('form-file-upload').submit();
                                    GS.addLoader('file-upload', 'Uploading file...');
                                }
                            });

                            document.getElementById('upload-file-content').addEventListener('change', function(event) {
                                var strValue = this.value, uploadFileNameControl = document.getElementById('upload-file-name');

                                uploadFileNameControl.value = uploadFileNameControl.value + strValue.substring(strValue.lastIndexOf('\\') + 1);
                                uploadFileNameControl.focus();
                            });

                            document.getElementById('upload-file-name').addEventListener('keydown', function(event) {
                                if (event.keyCode === 13) {
                                    GS.triggerEvent('click', document.getElementById('new-file-upload'));
                                }
                            });
                            
                            //document.getElementById('upload-response-iframe').removeEventListener('load', loadFunction);
                            //document.getElementById('upload-response-iframe').addEventListener('load', loadFunction);
                        }
                    });
                });
                
                document.getElementById('button-new-file').addEventListener('click', function(event) {
                    GS.dialog({
                        'header': 'Create a new File',
                        'content': '<div style="padding: 1em;">' +
                                        '<label for="new-file-name">File name:</label>' +
                                        '<gs-text id="new-file-name" value="' + filePathPrefix('') + '"></gs-text>' +
                                    '</div>',
                        'buttons': 'okcancel',
                        'after_open': function(event) {
                            var dialog = this, newFileNameControl = document.getElementById('new-file-name');

                            // insert empty file
                            newFileNameControl.focus();
                            GS.setInputSelection(newFileNameControl, newFileNameControl.value.length);
                            /*
                            // This is built into the dialog now
                            newFileNameControl.addEventListener('keydown', function (event) {
                                if (event.keyCode === 13) {
                                    GS.dialogClose(dialog, 'Ok');
                                }
                            });*/
                        },
                        'after_close': function(event, strAnswer) {
                            if (strAnswer === 'Ok') {
                                insertFile(xtag.query(this, '#new-file-name')[0].value);
                            }
                        }
                    });
                });
                
                document.getElementById('button-new-folder').addEventListener('click', function() {
                    GS.dialog({
                        'header': 'Create a new Folder',
                        'content': '<div style="padding: 1em;">' +
                                        '<label for="new-folder-name">Folder name:</label>' +
                                        '<gs-text id="new-folder-name" value="' + filePathPrefix('') + '"></gs-text>' +
                                    '</div>',
                        'buttons': 'okcancel',
                        'after_open': function(event) {
                            var dialog = this, newFolderNameControl = document.getElementById('new-folder-name');
                            
                            newFolderNameControl.focus();
                            GS.setInputSelection(newFolderNameControl.value.length);
                            
                            newFolderNameControl.addEventListener('keydown', function(event) {
                                if (event.keyCode === 13) {
                                    GS.dialogClose(dialog, 'Ok');
                                }
                            });
                        },
                        'after_close': function(event, strAnswer) {
                            if (strAnswer === 'Ok') {
                                insertFolder(xtag.query(this, '#new-folder-name')[0].value);
                            }
                        }
                    });
                });
                
                // this function has to fluidly operate across linear terrain with duo capibilities for maximum conservation of static lines
                operateFunction = function (strAction, operationFunction) { 
                    document.getElementById('current-action-container').innerHTML =  '<gs-grid widths="1,1">' +
                                                                                    '   <gs-block>' +
                                                                                    '       <gs-button id="button-cancel">Cancel</gs-button>' +
                                                                                    '   </gs-block>' +
                                                                                    '   <gs-block>' +
                                                                                    '       <gs-button id="button-confirm">' + strAction + ' Here</gs-button>' +
                                                                                    '   </gs-block>' +
                                                                                    '</gs-grid>';
                    
                    document.getElementById('button-cancel').addEventListener('click', function (event) {
                        document.getElementById('current-action-container').innerHTML = '';
                    });
                    
                    document.getElementById('button-confirm').addEventListener('click', function (event) {
                        var i, len, arrFiles = [],
                            arrFolders = [],
                            strNewFolder = arrCurrentPath.length > 0 ? arrCurrentPath.join('/') + '/' : '',
                            strCurrentPathName,
                            strCurrentPathNameInsertIndex;
                        
                        document.getElementById('current-action-container').innerHTML = '';
                        
                        // seperate files and folders
                        for (i = 0, len = arrCheckedPaths.length; i < len; i += 1) {
                            if (arrCheckedPathTypes[i] === 'file') {
                                arrFiles.push(arrCheckedPaths[i]);
                            } else {
                                arrFolders.push(arrCheckedPaths[i]);
                            }
                        }
                        
                        // rename files
                        for (i = 0, len = arrFiles.length; i < len; i += 1) {
                            strCurrentPathName = arrFiles[i].substring(arrFiles[i].lastIndexOf('/') + 1, arrFiles[i].length);
                            
                            if (strNewFolder === arrFiles[i].substring(0, arrFiles[i].lastIndexOf('/') + 1) && strAction !== 'Move') {
                                strCurrentPathNameInsertIndex = strCurrentPathName.lastIndexOf('.');
                                
                                strCurrentPathNameInsertIndex = strCurrentPathNameInsertIndex >= 0 ? strCurrentPathNameInsertIndex : strCurrentPathName.length;
                                
                                strCurrentPathName = strCurrentPathName.substring(0, strCurrentPathNameInsertIndex) + 
                                                     '_copy' +
                                                     strCurrentPathName.substring(strCurrentPathNameInsertIndex);
                            }
                            
                            arrFiles[i] = strNewFolder + strCurrentPathName;
                        }
                        
                        // rename folders
                        for (i = 0, len = arrFolders.length; i < len; i += 1) {
                            strCurrentPathName = arrFolders[i].substring(arrFolders[i].lastIndexOf('/') + 1, arrFolders[i].length);
                            
                            if (strNewFolder === arrFolders[i].substring(0, arrFolders[i].lastIndexOf('/') + 1) && strAction !== 'Move') {
                                strCurrentPathNameInsertIndex =
                                    strCurrentPathNameInsertIndex >= 0 ? strCurrentPathNameInsertIndex : strCurrentPathName.length;
                                
                                strCurrentPathName = strCurrentPathName.substring(0, strCurrentPathNameInsertIndex) + 
                                                     '_copy' +
                                                     strCurrentPathName.substring(strCurrentPathNameInsertIndex);
                            }
                            
                            arrFolders[i] = strNewFolder + strCurrentPathName;
                        }
                        
                        // operate
                        operationFunction('["' + getCheckedInOrder().join('","') + '"]', '["' + sortPathArraysInOperationOrder(arrFiles, arrFolders).join('","') + '"]');
                    });
                    
                    document.getElementById('button-confirm').focus();
                };
                
                document.getElementById('button-move').addEventListener('click', function (event) {
                    operateFunction('Move', movePaths);
                });
                document.getElementById('button-copy').addEventListener('click', function (event) {
                    operateFunction('Paste', copyPaths);
                });
                
                document.getElementById('button-delete').addEventListener('click', function (event) {
                    var i, len, path_i, path_len, strHTML,
                        arrCheckedSorted, arrFiles = [],
                        arrFolders = [],
                        strCurrentPath = arrCurrentPath.join('/');

                    // seperate files and folders
                    for (i = 0, len = arrCheckedPaths.length; i < len; i += 1) {
                        if (arrCheckedPathTypes[i] === 'file') {
                            arrFiles.push(arrCheckedPaths[i]);
                        } else {
                            arrFolders.push(arrCheckedPaths[i]);
                        }
                    }

                    arrCheckedSorted = sortPathArraysInOperationOrder(arrFiles, arrFolders);

                    for (i = 0, len = arrCheckedSorted.length, strHTML = ''; i < len; i += 1) {
                        strHTML += '<gs-button>' + encodeHTML(arrCheckedSorted[i]) + '</gs-button>';
                    }

                    GS.dialog({
                        'header': 'Are you sure?',
                        'content': '<div style="padding: 1em;">Are you sure that you want to delete the selected files and folders?<br /><br />' + strHTML + '</div>',
                        'buttons': 'yesno',
                        'after_close': function(event, strAnswer) {
                            if (strAnswer === 'Yes') {
                                //console.log(strCurrentPath);
                                
                                for (i = 0, len = arrFolders.length; i < len; i += 1) {
                                    if (strCurrentPath.indexOf(arrFolders[i]) === 0) {
                                        strCurrentPath = arrFolders[i].substring(0, arrFolders[i].lastIndexOf('/'));
                                        //console.log(strCurrentPath);
                                    }
                                }
                                
                                arrCurrentPath = strCurrentPath ? strCurrentPath.split('/') : [];
                                
                                deletePaths('["' + arrCheckedSorted.join('","') + '"]');
                            }
                        }
                    });
                });
                
                document.getElementById('button-rename').addEventListener('click', function(event) {
                    var i, len, strHTML, arrCheckedSorted = getCheckedInOrder(), strCurrentPath;
                    
                    for (i = 0, len = arrCheckedSorted.length, strHTML = ''; i < len; i += 1) {
                        strCurrentPath = arrCheckedSorted[i];
                        
                        strHTML += '<label>' + encodeHTML(strCurrentPath) + '</label>' +
                                '<gs-text class="rename-input" path-start="' + encodeHTML(strCurrentPath.substring(0, strCurrentPath.lastIndexOf('/') + 1)) +
                                        '" value="' + encodeHTML(strCurrentPath.substring(strCurrentPath.lastIndexOf('/') + 1)) + '"></gs-text>';
                    }
                    
                    GS.dialog({
                        'header': 'File / Folder Rename',
                        'content': '<div style="padding: 1em;">Change the input' + (arrCheckedSorted.length > 1 ? 's' : '') + ' then click "Ok" to change the file / folder names<br /><br />' + strHTML + '</div>',
                        'buttons': 'okcancel',
                        'after_close': function (event, strAnswer) {
                            var dialog = this, arrNewPathNames = [], i, len, arrInput;
                            
                            if (strAnswer === 'Ok') {
                                arrInput = xtag.query(dialog, '.rename-input');
                                
                                for (i = 0, len = arrInput.length; i < len; i += 1) {
                                    arrNewPathNames.push(arrInput[i].getAttribute('path-start') + arrInput[i].value);
                                }
                                
                                renamePaths('["' + arrCheckedSorted.join('","') + '"]', '["' + arrNewPathNames.join('","') + '"]');
                            }
                        }
                    });
                });
            });
        </script>
        <style>
            #file-list,
            #deleted-file-list {
                padding: 0.5em;
            }
            
            #file-list gs-button,
            #deleted-file-list gs-button {
                text-align: left;
            }
            
            #file-list > h3
            #deleted-file-list > h3 {
                margin-top: 0;
                margin-bottom: 0.2em;
            }
            
            .check {
                width: 1.5em;
            }
            
            .font-adjustment {
                font-size: 0.8em;
            }
            
            gs-button, gs-checkbox {
                border-radius: 0.5em;
            }
            
            gs-page > gs-header {
                padding-bottom: 0;
                padding-left: 0.25em;
                padding-right: 0.25em;
            }
            
            gs-page > gs-footer {
                padding: 0.25em;
            }
        </style>
    </head>
    <body class="blue">
        <gs-page>
            <gs-header>
                <div flex-horizontal>
                    <h3 id="current-path" flex>File Manager</h3>
                    <gs-button id="button-refresh" icononly icon="refresh" title="Refresh file list..." remove-right></gs-button>
                    <gs-button id="button-checked" disabled icononly icon="check" title="Look at all checked files and folders" remove-all></gs-button>
                    <gs-button target="_blank" icononly icon="search" href="/v1/app/all/search/index.html" title="Go to search page..." remove-left></gs-button>
                </div>
                <br hide-on-phone />
                <div class="font-adjustment">
                    <gs-grid not-responsive>
                        <gs-block width="7">
                            <gs-button id="button-back" disabled icontop icon="arrow-left" remove-right>Back</gs-button>
                        </gs-block>
                        <gs-block width="7">
                            <gs-button id="button-up" disabled icontop icon="arrow-up" remove-all>Up</gs-button>
                        </gs-block>
                        <gs-block width="7">
                            <gs-button id="button-new-file" icontop icon="plus" remove-all>File</gs-button>
                        </gs-block>
                        <gs-block width="7">
                            <gs-button id="button-upload-file" icontop icon="upload" remove-all>Upload</gs-button>
                        </gs-block>
                        <gs-block width="7">
                            <gs-button id="button-new-folder" icontop icon="plus" remove-left>Folder</gs-button>
                        </gs-block>
                    </gs-grid>
                </div>
            </gs-header>
            <gs-body>
                <div id="file-list"></div>
                <div id="deleted-file-list"></div>
            </gs-body>
            <gs-footer>
                <div class="font-adjustment">
                    <div id="current-action-container"></div>
                    <gs-grid width="36" not-responsive>
                        <gs-block width="9">
                            <gs-button id="button-move" disabled icontop icon="exchange" remove-right>Move</gs-button>
                        </gs-block>
                        <gs-block width="9">
                            <gs-button id="button-rename" disabled icontop icon="keyboard-o" remove-all>Rename</gs-button>
                        </gs-block>
                        <gs-block width="9">
                            <gs-button id="button-copy" disabled icontop icon="clipboard" remove-all>Copy</gs-button>
                        </gs-block>
                        <gs-block width="9">
                            <gs-button id="button-delete" disabled icontop icon="times" remove-left>Delete</gs-button>
                        </gs-block>
                    </gs-grid>
                </div>
            </gs-footer>
        </gs-page>
        <iframe src="file_upload_response_target.html" id="upload-response-iframe" name="upload_response" hidden></iframe>
    </body>
</html>